graph TD
    subgraph "Konfiguracja Terraform w C:\\prog_AWS_DEVOPS\\rs-devops-course-tasks\\"
        direction LR

        subgraph "Pliki Konfiguracyjne"
            V["variables.tf"]
            M["main.tf"]
            B["backend.tf (S3 Backend - aktywny)"]
            P["providers.tf"]
            O["outputs.tf"]
            I["iam.tf"]
            LOCK[".terraform.lock.hcl"]
        end

        subgraph "Zmienne (variables.tf)"
            V_Region["var.aws_region<br>(default: 'eu-west-1')"]
            V_BackendBucketName["var.s3_backend_bucket_name<br>(default: 'backend-tfstate-alan.kowalzky')"]
            V_AppBucketName["var.application_data_s3_bucket_name<br>(default: 'application-data-alan.kowalzky')"]
            V_GH_RoleName["var.github_actions_role_name<br>(default: 'GithubActionsRole')"]
            V_GH_User["var.github_org_or_user<br>(default: 'alan.kowalzky')"]
            V_GH_Repo["var.github_repo_name<br>(default: 'rs-devops-course-tasks')"]
        end

        subgraph "Zasoby S3 (main.tf)"
            S3_Backend_Bucket["aws_s3_bucket.s3_backend_bucket<br>bucket = var.s3_backend_bucket_name"]
            S3_App_Bucket["aws_s3_bucket.application_data_bucket<br>bucket = var.application_data_s_bucket_name"]
            S3_Backend_Versioning["aws_s3_bucket_versioning.s3_backend_bucket_versioning<br>bucket = S3_Backend_Bucket.id"]
            S3_Backend_SSE["aws_s3_bucket_server_side_encryption_configuration.s3_backend_bucket_sse<br>bucket = S3_Backend_Bucket.id"]
            S3_App_Versioning["aws_s3_bucket_versioning.application_data_bucket_versioning<br>bucket = S3_App_Bucket.id"]
            S3_App_SSE["aws_s3_bucket_server_side_encryption_configuration.application_data_bucket_sse<br>bucket = S3_App_Bucket.id"]
        end

        subgraph "Zasoby IAM (iam.tf)"
            IAM_Role["aws_iam_role.github_actions_role<br>name = var.github_actions_role_name"]
            IAM_Policy_Doc["data.aws_iam_policy_document.github_actions_assume_role_policy"]
            IAM_Caller_Identity["data.aws_caller_identity.current"]
            IAM_Attachment_EC2["aws_iam_role_policy_attachment.github_actions_ec2_full"]
            IAM_Attachment_R53["aws_iam_role_policy_attachment.github_actions_route53_full"]
            IAM_Attachment_S3["aws_iam_role_policy_attachment.github_actions_s3_full"]
            IAM_Attachment_IAM["aws_iam_role_policy_attachment.github_actions_iam_full"]
            IAM_Attachment_VPC["aws_iam_role_policy_attachment.github_actions_vpc_full"]
            IAM_Attachment_SQS["aws_iam_role_policy_attachment.github_actions_sqs_full"]
            IAM_Attachment_EventBridge["aws_iam_role_policy_attachment.github_actions_eventbridge_full"]
        end

        subgraph "Konfiguracja Backendu S3 (backend.tf)"
            BackendConfig["backend 's3'<br>bucket = 'backend-tfstate-alan.kowalzky'<br>key = 'global/s3/terraform.tfstate'<br>region = 'eu-west-1'"]
        end

        subgraph "Stan Terraform"
            TFState["terraform.tfstate<br>(przechowywany w S3_Backend_Bucket)"]
        end

        V --> V_Region
        V --> V_BackendBucketName
        V --> V_AppBucketName
        V --> V_GH_RoleName
        V --> V_GH_User
        V --> V_GH_Repo

        M --> S3_Backend_Bucket
        M --> S3_App_Bucket
        M --> S3_Backend_Versioning
        M --> S3_Backend_SSE
        M --> S3_App_Versioning
        M --> S3_App_SSE

        V_BackendBucketName --> S3_Backend_Bucket
        V_AppBucketName --> S3_App_Bucket

        S3_Backend_Bucket --> S3_Backend_Versioning
        S3_Backend_Bucket --> S3_Backend_SSE
        S3_App_Bucket --> S3_App_Versioning
        S3_App_Bucket --> S3_App_SSE

        I --> IAM_Role
        I --> IAM_Policy_Doc
        I --> IAM_Caller_Identity
        I --> IAM_Attachment_EC2
        I --> IAM_Attachment_R53
        I --> IAM_Attachment_S3
        I --> IAM_Attachment_IAM
        I --> IAM_Attachment_VPC
        I --> IAM_Attachment_SQS
        I --> IAM_Attachment_EventBridge

        V_GH_RoleName --> IAM_Role
        V_GH_User --> IAM_Policy_Doc
        V_GH_Repo --> IAM_Policy_Doc
        IAM_Caller_Identity --> IAM_Policy_Doc
        IAM_Policy_Doc --> IAM_Role

        IAM_Role --> IAM_Attachment_EC2
        IAM_Role --> IAM_Attachment_R53
        IAM_Role --> IAM_Attachment_S3
        IAM_Role --> IAM_Attachment_IAM
        IAM_Role --> IAM_Attachment_VPC
        IAM_Role --> IAM_Attachment_SQS
        IAM_Role --> IAM_Attachment_EventBridge

        B --> BackendConfig
        BackendConfig --> S3_Backend_Bucket # Backend używa tego bucketa
        BackendConfig --> TFState # Stan jest zapisywany zgodnie z konfiguracją backendu

        P --> V_Region # providers.tf używa var.aws_region

        S3_Backend_Bucket --> O # outputs.tf odwołuje się do s3_backend_bucket
        S3_App_Bucket --> O # outputs.tf odwołuje się do application_data_bucket
        
        LOCK -.-> P # .terraform.lock.hcl zarządza wersjami dostawców

        style V fill:#f9f,stroke:#333,stroke-width:2px
        style M fill:#f9f,stroke:#333,stroke-width:2px
        style B fill:#f9f,stroke:#333,stroke-width:2px
        style P fill:#f9f,stroke:#333,stroke-width:2px
        style O fill:#f9f,stroke:#333,stroke-width:2px
        style I fill:#f9f,stroke:#333,stroke-width:2px
        style LOCK fill:#eee,stroke:#333,stroke-width:1px

        style V_Region fill:#ccf,stroke:#333,stroke-width:2px
        style V_BackendBucketName fill:#ccf,stroke:#333,stroke-width:2px
        style V_AppBucketName fill:#ccf,stroke:#333,stroke-width:2px
        style V_GH_RoleName fill:#ccf,stroke:#333,stroke-width:2px
        style V_GH_User fill:#ccf,stroke:#333,stroke-width:2px
        style V_GH_Repo fill:#ccf,stroke:#333,stroke-width:2px

        style S3_Backend_Bucket fill:#cfc,stroke:#333,stroke-width:2px
        style S3_App_Bucket fill:#cfc,stroke:#333,stroke-width:2px
        style S3_Backend_Versioning fill:#cfc,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5
        style S3_Backend_SSE fill:#cfc,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5
        style S3_App_Versioning fill:#cfc,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5
        style S3_App_SSE fill:#cfc,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5

        style IAM_Role fill:#ffc,stroke:#333,stroke-width:2px
        style IAM_Policy_Doc fill:#ffc,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5
        style IAM_Caller_Identity fill:#ffc,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5
        style IAM_Attachment_EC2 fill:#ffc,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5
        style IAM_Attachment_R53 fill:#ffc,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5
        style IAM_Attachment_S3 fill:#ffc,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5
        style IAM_Attachment_IAM fill:#ffc,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5
        style IAM_Attachment_VPC fill:#ffc,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5
        style IAM_Attachment_SQS fill:#ffc,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5
        style IAM_Attachment_EventBridge fill:#ffc,stroke:#333,stroke-width:1px,stroke-dasharray: 5 5

        style BackendConfig fill:#fcc,stroke:#333,stroke-width:2px
        style TFState fill:#ddd,stroke:#333,stroke-width:2px
    end
